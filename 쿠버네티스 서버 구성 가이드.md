
기존 MisoBot 운영 서버와 상이한 Ubuntu 22.04.5 LTS 사용하므로 기존 가이드 사용 불가

Kubernetes 재구성 시 하위 명령어들 꼭 있어야 함!! Kubernetes는 **v1.20부터 `dockershim`을 지원 중단했고, v1.24부터 완전히 제거됨**

**CRI(Container Runtime Interface)** 라는 표준 API로 사용 하여야 함.

**OS**

Ubuntu 22.04.5 LTS

**마스터 노드 사용 버전**

Client Version: v1.29.15 Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3 Server Version: v1.29.15

워커 노드 사용 버전

Client Version: v1.29.15 Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3

### 1. 마스터 노드 설정

```jsx

# 기본 패키지 설치 및 Docker 저장소 추가
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

# Docker 공식 GPG 키 저장
curl -fsSL <https://download.docker.com/linux/ubuntu/gpg> | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Docker APT 저장소 등록
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <https://download.docker.com/linux/ubuntu> $(lsb_release -cs) stable" | \\
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Docker 및 containerd 설치
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# swap 비활성화 
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# 커널 모듈 로딩 및 sysctl 설정
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

# containerd 설정
sudo mkdir -p /etc/containerd

# 기본 설정 파일 생성
containerd config default | sudo tee /etc/containerd/config.toml

**# systemd cgroup 사용 설정 <------ 꼭 필요!!!!**
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# containerd 재시작
sudo systemctl restart containerd

# Kubernetes 저장소 추가 및 설치
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl

**# Kubernetes GPG 키 저장 (GPG 키를 미사용하거나 다른 키를 사용하는 경우 바뀌는 부분)**
sudo mkdir -p /etc/apt/keyrings
curl -fsSL <https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key> | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# Kubernetes APT 저장소 등록
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] <https://pkgs.k8s.io/core:/stable:/v1.28/deb/> /' | \\
sudo tee /etc/apt/sources.list.d/kubernetes.list   

# Kubernetes 구성요소 설치
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl

# 자동 업데이트 방지
sudo apt-mark hold kubelet kubeadm kubectl

# Kubernetes 클러스터 초기화
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///run/containerd/containerd.sock

# kubectl 설정 (일반 사용자용)
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Flannel CNI 설치 (Pod 네트워크 애드온)
kubectl apply -f <https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml>

# 클러스터링 IP 및 포트를 외부 노출하기 위한 Ingress 설정
kubectl apply -f <https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/baremetal/deploy.yaml>
kubectl get svc -n ingress-nginx

```

### 2. 워커 노드 설정

```jsx

# Docker 및 containerd 설치 준비
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

# swap 비활성화 
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# 커널 모듈 로딩 및 sysctl 설정
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

# Docker 공식 GPG 키 등록
curl -fsSL <https://download.docker.com/linux/ubuntu/gpg> | \\
sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Docker 저장소 등록
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <https://download.docker.com/linux/ubuntu> $(lsb_release -cs) stable" | \\
sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Docker 및 containerd 설치
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# containerd 설정
sudo mkdir -p /etc/containerd

# 기본 설정 생성
containerd config default | sudo tee /etc/containerd/config.toml

# systemd cgroup 사용 설정
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

# containerd 재시작
sudo systemctl restart containerd

# Kubernetes 저장소 추가 및 kubelet/kubeadm/kubectl 설치
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl

# Kubernetes GPG 키 등록
sudo mkdir -p /etc/apt/keyrings
curl -fsSL <https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key> | \\
sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# Kubernetes 저장소 등록
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] <https://pkgs.k8s.io/core:/stable:/v1.28/deb/> /' | \\
sudo tee /etc/apt/sources.list.d/kubernetes.list

# Kubernetes 컴포넌트 설치
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl

# 자동 업데이트 방지
sudo apt-mark hold kubelet kubeadm kubectl

# 워커 노드를 클러스터에 조인
sudo kubeadm join <master-ip>:<master-port> \\
  --token <token> \\
  --discovery-token-ca-cert-hash sha256:<hash> \\
  --cri-socket unix:///run/containerd/containerd.sock
```

### 3. 명령어 공통

```jsx

// containerd 재시작 및 상태 확인
systemctl restart containerd
systemctl status containerd

// containerd 상태 확인
systemctl status containerd
```

### 4. 마스터 노드 전용

```jsx
// 노드 상태 확인
kubectl get nodes -o wide

// pods 상태 확인
kubectl get pods -o wide

// 전체 pods 확인
kubectl get pods --all-namespaces

// 서비스 상태 확인
kubectl get svc -o wide

// 클러스터 상태 확인
kubectl cluster-info

// containerd 상태 확인
systemctl status containerd

**// 특정 워커노드 제거 (그냥 Delete 하면 워커노드가 다시 Join 할때 오류 발생함)**
kubectl drain k8s-node-{워커노드 번호} --ignore-daemonsets --delete-emptydir-data
kubectl delete node k8s-node-{워커노드 번호}

// Pod 쉘 접속
kubectl exec -it {deployment명} -- /bin/sh

// 마스터 노드에서 Ingress 설정 시 connect: connection refused 오류가 나는 경우
kubectl get ValidatingWebhookConfiguration -A
kubectl delete validatingwebhookconfiguration ingress-nginx-admission

// Control plane 정상 여부 확인
kubectl get componentstatuses

// 마스터 노드의 Join 토큰 확인
kubeadm token create --print-join-command

```

### 5. 워커 노드 전용

```jsx
// 워커노드 호스트 수정 (containerd 소켓 사용 명시)
hostnamectl status
sudo hostnamectl set-hostname misobot-wnode{워커노드 번호}

// 마스터노드 조인 시 로그 출력
sudo kubeadm join {마스터 노드 호스트}:{마스터 노드 포트} \\
  --token hl6dcl.yxgpsgkwhrf0oqis \\
  --discovery-token-ca-cert-hash sha256:{마스터 노드 해시코드} \\
  --cri-socket unix:///run/containerd/containerd.sock \\
  --v=5
```

마스터 노드 ↔ 워커 노드 간 정상 연결 상태

![1.png](attachment:b61f9466-a847-4590-8433-99ae9b3175b7:1.png)

(공통) 노드 초기화

```jsx
# Kubernetes 관련 패키지 및 설정 제거
sudo kubeadm reset
sudo apt-get purge kubeadm kubectl kubelet kubernetes-cni kube* -y
sudo rm -rf ~/.kube

# Docker 관련 패키지 제거 (Docker를 사용하지 않으므로 필요시 삭제)
sudo apt-get purge docker-ce docker-ce-cli containerd.io -y
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd

# 기타 관련된 설정 및 캐시 삭제
sudo apt-get autoremove -y
sudo apt-get clean

```

워커 노드에서 마스터 노드에 Join이 되지 않는 경우

마스터 노드에서 강제로 Delete 하는 경우 워커 노드의 정보가 남아있기 때문에 중복 Join이 불가능함 , 따라서 아래 명령어로 삭제

```jsx
# 1. 노드 초기화 (kubeadm 설정 삭제)
sudo kubeadm reset -f

# 2. 서비스 중지
sudo systemctl stop kubelet containerd

# 3. CNI 관련 설정 및 잔재 삭제
sudo rm -rf /etc/cni/net.d /var/lib/cni /run/flannel /etc/kubernetes

# 4. 충돌나는 네트워크 인터페이스 삭제 (아래는 예시)
sudo ip link delete cni0
sudo ip link delete flannel.1

# 5. containerd 및 kubelet 재시작
sudo systemctl restart containerd kubelet

```

마스터 노드의 Join 설정을 초기화 하는 경우

```jsx
# kubeadm 설정 삭제
sudo kubeadm reset -f

# Kubernetes 클러스터 초기화
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///run/containerd/containerd.sock

# kubectl 설정 (일반 사용자용)
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

**# Flannel CNI 재설치 <--- 클러스터 초기화 이후 재설치 해줘야함 (Pod 네트워크 애드온)**
kubectl apply -f <https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml>
```

`SystemdCgroup`는 **Kubernetes의 kubelet 설정** 중 하나로, **container runtime과 cgroup 드라이버를 어떻게 연동할지를 설정하는 옵션**

/etc/containerd/config.toml 파일의 해당 옵션이 false 인 경우,

컨테이너가 정상 실행되었음에도 주기적으로 pods crash 및 SandboxChanged로 인해 kube-system pod가 다시 시작되는 이슈

@[**fabi200123](https://github.com/fabi200123) 유저가 해결함**

[Constant kube-system pod restard due to SandboxChanged under ubuntu Jammy · Issue #110177 · kubernetes/kubernetes](https://github.com/kubernetes/kubernetes/issues/110177)

관련 Doc

[Installing and Configuring containerd as a Kubernetes Container Runtime - Anthony Nocentino's Blog](https://www.nocentino.com/posts/2021-12-27-installing-and-configuring-containerd-as-a-kubernetes-container-runtime/#configure-required-modules)

코드상 SSH 명령 실행이 안되는 경우

SSH 접속 사용자가 root 권한이 아닐 수 있으므로 해당 config 설정 파일을 SSH 접속 사용자 디렉터리로 옮겨야 함

```jsx
// 에러로그 예시 
SSH 접속 사용자: **misodev**
The connection to the server localhost:8080 was refused - did you specify the right host or port?
couldn't get current server API group list: Get "<http://localhost:8080/api?timeout=32s>": dial tcp 127.0.0.1:8080: connect: connection refused

// java에서 SSH 접속 계정 확인
BufferedReader whoamiReader = new BufferedReader(new InputStreamReader(whoamiIn));
String currentUser = whoamiReader.readLine();
LOGGER.info("SSH 접속 사용자: " + currentUser);
whoamiChannel.disconnect();

**// config 파일** 
sudo mkdir -p /home/{접속사용자}/.kube
sudo cp /root/.kube/config /home/{접속사용자}/.kube/config
sudo chown {접속사용자-유저}:{접속사용자-그룹} /home/{접속사용자}/.kube/config
chmod 600 /home/{접속사용자}/.kube/config
```

컨테이너 내부에 접근하여 확인이 필요한 경우

```jsx
kubectl exec -it deployment-1402-689d6b7579-gxlgt -c container-1402 -- /bin/sh
```

컨테이너 내부 파일을 덮어쓰는경우

```jsx
kubectl cp ./connectDB.py deployment-1402-689d6b7579-gxlgt:/app/connectDB.py -c container-1402
```

도커 이미지 생성 및 Docker Hub Push

캐시가 남아있는 경우 체크섬 인증 실패

```jsx
docker build --no-cache -t msrnd2/misobot:m_0.0.8 .

docker push msrnd2/misobot:m_0.0.8
```

자주 쓰는 명령어

```jsx
// pods 상태 모니터링
kubectl get pods -o wide --watch

kubectl get pods -o wide
kubectl get svc -o wide
kubectl get nodes -o wide

kubectl delete pods --all
kubectl delete deployment --all
kubectl delete svc --all

kubectl apply -f /share001/misobot/misobot_file/bot/Deployment.yaml
kubectl apply -f /share001/misobot/misobot_file/bot/Service_nodePortVersion.yaml
kubectl apply -f /share001/misobot/misobot_file/bot/Ingress.yaml

// deployment 로그
kubectl describe pod deployment-2-b48bd756-zspnm

// 컨테이너 로그 확인
kubectl logs -f deployment-1-57d9dbb566-2jwdk -c container-1

```

Redis Celery 재실행

```jsx
ps aux | grep celery
kill -9 66
celery -A celery_app worker -l info -P eventlet --without-gossip --without-mingle --without-heartbeat -Ofair &
```

node port 확인 (api 호출 실패시 확인)

```jsx
globals.properties 에서 외부 접속용 url 지정 
mlClusterApiUrl=http://{masterNode ip}:{nodePort}

kubectl get svc -A

NAMESPACE       NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx   ingress-nginx-controller             NodePort    10.109.147.37    <none>        80:**31652**/TCP,443:32012/TCP   2d20h
```